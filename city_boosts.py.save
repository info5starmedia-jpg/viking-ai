XXimport os
import csv
import json
from typing import Any, Dict, List, Optional

# Optional city history file written by tour scanning enhancements (if you add them later)
CITY_HISTORY_PATH = os.getenv("CITY_HISTORY_PATH", "/opt/viking-ai/city_history.json")
EVENTS_CSV_PATH = os.getenv("EVENTS_CSV_PATH", "/opt/viking-ai/events.csv")

# A strong “starter universe” of tour markets (US/CA + EU/UK + AU/NZ). Extend anytime.
BASE_CITIES = [
    # USA (major)
    "New York, NY","Brooklyn, NY","Queens, NY","Newark, NJ","Jersey City, NJ",
    "Los Angeles, CA","Inglewood, CA","Anaheim, CA","San Diego, CA","San Francisco, CA","Oakland, CA","San Jose, CA","Sacramento, CA",
    "Chicago, IL","Rosemont, IL",
    "Dallas, TX","Fort Worth, TX","Houston, TX","Austin, TX","San Antonio, TX",
    "Phoenix, AZ","Glendale, AZ",
    "Denver, CO",
    "Seattle, WA","Tacoma, WA",
    "Portland, OR",
    "Las Vegas, NV",
    "Atlanta, GA",
    "Miami, FL","Fort Lauderdale, FL","Orlando, FL","Tampa, FL","Jacksonville, FL",
    "Washington, DC",
    "Philadelphia, PA",
    "Boston, MA",
    "Detroit, MI",
    "Minneapolis, MN","St. Paul, MN",
    "Cleveland, OH","Columbus, OH","Cincinnati, OH",
    "Pittsburgh, PA",
    "Nashville, TN",
    "Charlotte, NC","Raleigh, NC",
    "St. Louis, MO",
    "Kansas City, MO",
    "New Orleans, LA",
    "Salt Lake City, UT",
    "Indianapolis, IN",
    "Milwaukee, WI",
    "Baltimore, MD",

    # Canada
    "Toronto, ON","Vancouver, BC","Montreal, QC","Ottawa, ON","Calgary, AB","Edmonton, AB","Winnipeg, MB","Quebec City, QC","Halifax, NS",

    # UK / IE
    "London, UK","Manchester, UK","Birmingham, UK","Glasgow, UK","Edinburgh, UK","Leeds, UK","Liverpool, UK","Bristol, UK",
    "Dublin, IE","Belfast, UK",

    # Europe (major)
    "Paris, FR","Lyon, FR",
    "Amsterdam, NL","Rotterdam, NL",
    "Berlin, DE","Hamburg, DE","Munich, DE","Cologne, DE",
    "Brussels, BE",
    "Zurich, CH","Geneva, CH",
    "Vienna, AT",
    "Prague, CZ",
    "Warsaw, PL",
    "Stockholm, SE","Gothenburg, SE",
    "Oslo, NO",
    "Copenhagen, DK",
    "Helsinki, FI",
    "Barcelona, ES","Madrid, ES",
    "Lisbon, PT",
    "Milan, IT","Rome, IT",
    "Athens, GR",

    # AU/NZ
    "Sydney, AU","Melbourne, AU","Brisbane, AU","Perth, AU","Adelaide, AU",
    "Auckland, NZ","Wellington, NZ",
]

def _load_city_history() -> Dict[str, int]:
    try:
        with open(CITY_HISTORY_PATH, "r", encoding="utf-8") as f:
            data = json.load(f)
        if isinstance(data, dict):
            return {str(k): int(v) for k, v in data.items()}
    except Exception:
        pass
    return {}

def _tm_event_density() -> Dict[str, int]:
    """
    Uses events.csv if present (your repo has one). Counts city occurrences.
    Expects any of these columns (best effort): city, venue_city, market, location
    """
    density: Dict[str, int] = {}
    if not os.path.exists(EVENTS_CSV_PATH):
        return density

    try:
        with open(EVENTS_CSV_PATH, "r", encoding="utf-8", newline="") as f:
            reader = csv.DictReader(f)
            for row in reader:
                city = (
                    row.get("city")
                    or row.get("venue_city")
                    or row.get("market")
                    or row.get("location")
                    or ""
                ).strip()
                if not city:
                    continue
                density[city] = density.get(city, 0) + 1
    except Exception:
        return density

    return density

def rank_cities(artist: str, max_results: int = 25) -> List[Dict[str, Any]]:
    """
    Returns list of: {city, score, components}
    Components currently include:
      - base (1.0)
      - ticketmaster_density (scaled)
      - rss_history (scaled)
    Later you can inject Tavily/Google/YouTube enrichments here.
    """
    artist = (artist or "").strip()
    base = {c: 1.0 for c in BASE_CITIES}

    tm_density = _tm_event_density()
    history = _load_city_history()

    # Scale helper
    def _scale(v: int, max_v: int) -> float:
        if max_v <= 0:
            return 0.0
        return round(min(1.0, v / max_v), 4)

    max_tm = max(tm_density.values()) if tm_density else 0
    max_hist = max(history.values()) if history else 0

    results: List[Dict[str, Any]] = []
    for city, b in base.items():
        tm = _scale(tm_density.get(city, 0), max_tm)
        hist = _scale(history.get(city, 0), max_hist)

        # Weights: tune anytime
        score = (b * 1.0) + (tm * 2.2) + (hist * 1.6)

        results.append(
            {
                "city": city,
                "score": round(score, 3),
                "components": {
                    "base": b,
                    "ticketmaster_density": tm,
                    "rss_history": hist,
                },
            }
        )

    results.sort(key=lambda r: float(r.get("score") or 0), reverse=True)
    return results[: max_results or 25]
