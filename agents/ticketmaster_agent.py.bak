cd /opt/viking-ai
source .venv/bin/activate

# backup
cp -n agents/ticketmaster_agent.py agents/ticketmaster_agent.py.bak 2>/dev/null || true

cat > agents/ticketmaster_agent.py <<'PY'
"""
Real Ticketmaster implementation (canonical).

- ticketmaster_agent.py (root) imports from here.
- Keep function names stable for the rest of the app.
"""

from __future__ import annotations
from typing import Any, Dict, List
import os
import requests

TM_API_KEY = os.getenv("TICKETMASTER_API_KEY") or os.getenv("TM_API_KEY")
TM_DISCOVERY_BASE = os.getenv("TM_DISCOVERY_BASE", "https://app.ticketmaster.com/discovery/v2")


def _require_key() -> str:
    if not TM_API_KEY:
        raise RuntimeError(
            "Missing Ticketmaster API key. Set env var TICKETMASTER_API_KEY (or TM_API_KEY)."
        )
    return TM_API_KEY


def search_events_for_artist(
    artist: str,
    *,
    country_code: str = "US",
    size: int = 10,
    **kwargs,
) -> List[Dict[str, Any]]:
    """
    Search Ticketmaster Discovery API for events for an artist keyword.
    Returns a list of event dicts (raw-ish TM payload items).
    """
    key = _require_key()
    url = f"{TM_DISCOVERY_BASE}/events.json"
    params = {
        "apikey": key,
        "keyword": artist,
        "countryCode": country_code,
        "size": size,
    }
    params.update({k: v for k, v in kwargs.items() if v is not None})

    r = requests.get(url, params=params, timeout=20)
    r.raise_for_status()
    data = r.json()
    events = (data.get("_embedded") or {}).get("events") or []
    return events


def get_event_details(event_id: str, **kwargs) -> Dict[str, Any]:
    """
    Fetch event details by id from Ticketmaster Discovery API.
    """
    key = _require_key()
    url = f"{TM_DISCOVERY_BASE}/events/{event_id}.json"
    params = {"apikey": key}
    params.update({k: v for k, v in kwargs.items() if v is not None})

    r = requests.get(url, params=params, timeout=20)
    r.raise_for_status()
    return r.json()


def fetch_verified_fan_programs(*, country_code: str = "US") -> List[Dict[str, Any]]:
    """
    Verified Fan doesn't have a clean/public Discovery API endpoint.
    For now, keep the bot stable by returning [].

    Later: implement scraping from official TM VF pages, or
    maintain a curated list of VF program URLs and poll them.
    """
    return []
PY
